<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互評分配系統 (密碼保護版)</title>
    
    <!-- 1. 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 2. 引入 Babel (讓瀏覽器能看懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. 引入 Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 簡單的載入動畫與基礎設定 */
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

    <div id="root"></div>

    <!-- 4. 您的應用程式程式碼 -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 簡易圖示組件 ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Users: (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            User: (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Plus: (props) => <Icon {...props} path={<><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></>} />,
            RefreshCw: (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />,
            Save: (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Link: (props) => <Icon {...props} path={<><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            Calendar: (props) => <Icon {...props} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />,
            CheckCircle2: (props) => <Icon {...props} path={<><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></>} />,
            Lock: (props) => <Icon {...props} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
        };

        // --- 主應用程式組件 ---
        const PeerReviewApp = () => {
            // ---------------------------------------------------------
            // 狀態管理
            // ---------------------------------------------------------
            const [activeTab, setActiveTab] = useState('roster');
            const [roster, setRoster] = useState([]);
            const [assignments, setAssignments] = useState(null);
            const [newStudent, setNewStudent] = useState({ no: '', name: '', url: '' });
            const [error, setError] = useState('');

            // ---------------------------------------------------------
            // 初始化與持久化 (Local Storage)
            // ---------------------------------------------------------
            useEffect(() => {
                const savedRoster = localStorage.getItem('review_app_roster');
                const savedAssignments = localStorage.getItem('review_app_assignments');
                if (savedRoster) setRoster(JSON.parse(savedRoster));
                if (savedAssignments) {
                    setAssignments(JSON.parse(savedAssignments));
                    setActiveTab('assignments');
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('review_app_roster', JSON.stringify(roster));
            }, [roster]);

            useEffect(() => {
                if (assignments) {
                    localStorage.setItem('review_app_assignments', JSON.stringify(assignments));
                } else {
                    localStorage.removeItem('review_app_assignments');
                }
            }, [assignments]);

            // ---------------------------------------------------------
            // 邏輯函數
            // ---------------------------------------------------------
            
            const generateId = () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            };

            // --- 密碼驗證函數 ---
            const verifyAdminPassword = (actionName) => {
                const password = prompt(`⚠️ 安全驗證\n\n請輸入管理員密碼以執行「${actionName}」：`);
                if (password === '0426') {
                    return true;
                } else {
                    if (password !== null) {
                        alert("❌ 密碼錯誤！操作已取消。");
                    }
                    return false;
                }
            };

            // 載入範例資料
            const loadSampleData = () => {
                // 加入密碼驗證
                if (!verifyAdminPassword('載入範例資料')) return;

                const samples = Array.from({ length: 10 }, (_, i) => ({
                id: generateId(),
                no: String(i + 1).padStart(2, '0'),
                name: `學生 ${String.fromCharCode(65 + i)}`, 
                url: `https://example.com/work/${i + 1}`
                }));
                setRoster(samples);
                setAssignments(null);
                setError('');
            };

            // 清空名單
            const handleClearRoster = () => {
                // 加入密碼驗證
                if (!verifyAdminPassword('清空名單')) return;

                if (confirm('確定要清空所有名單嗎？此動作無法復原。')) {
                    setRoster([]);
                }
            };

            const handleAddStudent = (e) => {
                e.preventDefault();
                if (!newStudent.no || !newStudent.name) {
                setError('請填寫座號與姓名');
                return;
                }
                setRoster([...roster, { ...newStudent, id: generateId() }]);
                setNewStudent({ no: '', name: '', url: '' });
                setError('');
            };

            const removeStudent = (id) => {
                setRoster(roster.filter(s => s.id !== id));
            };

            const shuffle = (array) => {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            };

            // 核心分配邏輯
            const assignBalancedReviews = () => {
                if (!verifyAdminPassword('開始隨機分配')) return;

                const k = 3; 
                const n = roster.length;

                if (n < k + 1) {
                setError(`名單人數不足。目前 ${n} 人，至少需要 ${k + 1} 人才能互評且不評自己。`);
                return;
                }

                const indices = Array.from({ length: n }, (_, i) => i);
                const shuffledIndices = shuffle(indices);
                
                const S = shuffledIndices.map(idx => roster[idx]);

                const results = [];
                for (let i = 0; i < n; i++) {
                const me = S[i];
                const myTargets = [];
                
                for (let step = 1; step <= k; step++) {
                    const targetIndex = (i + step) % n;
                    myTargets.push(S[targetIndex]);
                }

                results.push({
                    reviewer: me,
                    targets: myTargets
                });
                }

                results.sort((a, b) => parseInt(a.reviewer.no) - parseInt(b.reviewer.no));

                const timestamp = new Date().toLocaleString('zh-TW', { hour12: false });
                
                setAssignments({
                data: results,
                meta: {
                    timestamp,
                    creator: 'Web Admin'
                }
                });
                
                setActiveTab('assignments');
                setError('');
            };

            const resetAssignments = () => {
                if (!verifyAdminPassword('清除並重抽')) return;

                if (confirm('確定要清除目前的分配結果嗎？下次執行將會重新抽籤。')) {
                    setAssignments(null);
                    setActiveTab('roster');
                }
            };

            // ---------------------------------------------------------
            // UI 元件 (JSX)
            // ---------------------------------------------------------
            return (
                <div className="min-h-screen bg-gray-50 p-4 font-sans text-slate-800 fade-in">
                <div className="max-w-5xl mx-auto bg-white shadow-xl rounded-xl overflow-hidden">
                    
                    {/* Header */}
                    <div className="bg-blue-600 p-6 text-white flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold flex items-center gap-2">
                        <Icons.Users className="w-8 h-8" />
                        互評分配系統
                        </h1>
                        <p className="text-blue-100 text-sm mt-1">
                        平均分配：每人評 3 位，不重複、不自評
                        </p>
                    </div>
                    <div className="text-right text-xs text-blue-200 hidden sm:block">
                        <div>React Web App</div>
                        <div className="flex items-center justify-end gap-1"><Icons.Lock className="w-3 h-3"/> Admin Protected</div>
                    </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex border-b border-gray-200">
                    <button
                        onClick={() => setActiveTab('roster')}
                        className={`flex-1 py-4 text-center font-medium transition-colors ${
                        activeTab === 'roster' 
                            ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' 
                            : 'text-gray-500 hover:bg-gray-50'
                        }`}
                    >
                        1. 學生名單 (Roster)
                    </button>
                    <button
                        onClick={() => setActiveTab('assignments')}
                        className={`flex-1 py-4 text-center font-medium transition-colors ${
                        activeTab === 'assignments' 
                            ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' 
                            : 'text-gray-500 hover:bg-gray-50'
                        }`}
                    >
                        2. 分配結果 (Assignments)
                    </button>
                    </div>

                    {/* Content Area */}
                    <div className="p-6">
                    {error && (
                        <div className="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 flex items-center gap-2 rounded-r">
                        <Icons.AlertCircle className="w-5 h-5" />
                        {error}
                        </div>
                    )}

                    {/* --- ROSTER TAB --- */}
                    {activeTab === 'roster' && (
                        <div className="space-y-6 fade-in">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h2 className="text-lg font-semibold text-gray-700">
                            目前名單 ({roster.length} 人)
                            </h2>
                            <div className="flex gap-2">
                            <button 
                                onClick={loadSampleData}
                                className="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded border border-gray-300 flex items-center gap-1 transition-colors"
                                title="需要密碼"
                            >
                                <Icons.Lock className="w-3 h-3 mr-1" />
                                <span className="flex items-center gap-1"><Icons.Save className="w-4 h-4" /> 載入範例資料</span>
                            </button>
                            <button 
                                onClick={handleClearRoster}
                                className="px-3 py-1.5 text-sm bg-red-50 hover:bg-red-100 text-red-600 rounded border border-red-200 flex items-center gap-1 transition-colors"
                                title="需要密碼"
                            >
                                <Icons.Lock className="w-3 h-3 mr-1" />
                                <span className="flex items-center gap-1"><Icons.Trash2 className="w-4 h-4" /> 清空名單</span>
                            </button>
                            </div>
                        </div>

                        {/* Add Student Form */}
                        <form onSubmit={handleAddStudent} className="bg-gray-50 p-4 rounded-lg border border-gray-200 grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
                            <div className="sm:col-span-2">
                            <label className="block text-xs font-medium text-gray-500 mb-1">座號</label>
                            <input
                                type="text"
                                placeholder="01"
                                className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300 outline-none"
                                value={newStudent.no}
                                onChange={e => setNewStudent({...newStudent, no: e.target.value})}
                            />
                            </div>
                            <div className="sm:col-span-3">
                            <label className="block text-xs font-medium text-gray-500 mb-1">姓名</label>
                            <input
                                type="text"
                                placeholder="王小明"
                                className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300 outline-none"
                                value={newStudent.name}
                                onChange={e => setNewStudent({...newStudent, name: e.target.value})}
                            />
                            </div>
                            <div className="sm:col-span-5">
                            <label className="block text-xs font-medium text-gray-500 mb-1">作品網址 (選填)</label>
                            <input
                                type="text"
                                placeholder="https://..."
                                className="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300 outline-none"
                                value={newStudent.url}
                                onChange={e => setNewStudent({...newStudent, url: e.target.value})}
                            />
                            </div>
                            <div className="sm:col-span-2">
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded flex justify-center items-center gap-1 transition-colors">
                                <Icons.Plus className="w-4 h-4" /> 新增
                            </button>
                            </div>
                        </form>

                        {/* Student List */}
                        <div className="border rounded-lg overflow-hidden">
                            <table className="w-full text-left text-sm">
                            <thead className="bg-gray-100 text-gray-600 uppercase tracking-wider font-semibold">
                                <tr>
                                <th className="p-3 w-20">座號</th>
                                <th className="p-3 w-32">姓名</th>
                                <th className="p-3">作品網址</th>
                                <th className="p-3 w-20 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200 bg-white">
                                {roster.length === 0 ? (
                                <tr>
                                    <td colSpan="4" className="p-8 text-center text-gray-400 italic">
                                    目前沒有資料，請新增或載入範例。
                                    </td>
                                </tr>
                                ) : (
                                roster.map((student) => (
                                    <tr key={student.id} className="hover:bg-gray-50">
                                    <td className="p-3 font-medium text-gray-900">{student.no}</td>
                                    <td className="p-3 text-gray-800">{student.name}</td>
                                    <td className="p-3 text-blue-600 truncate max-w-xs">
                                        {student.url ? (
                                        <a href={student.url} target="_blank" rel="noreferrer" className="hover:underline flex items-center gap-1">
                                            <Icons.Link className="w-3 h-3" /> {student.url}
                                        </a>
                                        ) : <span className="text-gray-300">-</span>}
                                    </td>
                                    <td className="p-3 text-center">
                                        <button onClick={() => removeStudent(student.id)} className="text-gray-400 hover:text-red-500 transition-colors">
                                        <Icons.Trash2 className="w-4 h-4 mx-auto" />
                                        </button>
                                    </td>
                                    </tr>
                                ))
                                )}
                            </tbody>
                            </table>
                        </div>
                        
                        <div className="flex justify-end mt-4">
                            <button
                            onClick={assignBalancedReviews}
                            disabled={roster.length < 4 || assignments !== null}
                            className={`px-6 py-3 rounded-lg font-bold shadow-md flex items-center gap-2 transition-all transform active:scale-95 ${
                                assignments !== null
                                ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                : roster.length < 4
                                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    : 'bg-green-600 hover:bg-green-700 text-white'
                            }`}
                            >
                            {assignments ? (
                                <>
                                <Icons.CheckCircle2 className="w-5 h-5" /> 已產生分配
                                </>
                            ) : (
                                <>
                                <Icons.Lock className="w-4 h-4 mr-1" />
                                <Icons.RefreshCw className="w-5 h-5" /> 開始隨機分配
                                </>
                            )}
                            </button>
                        </div>
                        {assignments && (
                            <p className="text-right text-xs text-gray-500 mt-2">
                            若要重新分配，請至「分配結果」頁籤清除結果。
                            </p>
                        )}
                        </div>
                    )}

                    {/* --- ASSIGNMENTS TAB --- */}
                    {activeTab === 'assignments' && (
                        <div className="space-y-6 fade-in">
                        
                        {!assignments ? (
                            <div className="text-center py-16 bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg">
                            <div className="mx-auto bg-white w-16 h-16 rounded-full flex items-center justify-center shadow-sm mb-4">
                                <Icons.Users className="w-8 h-8 text-gray-300" />
                            </div>
                            <h3 className="text-lg font-medium text-gray-900">尚未產生分配結果</h3>
                            <p className="text-gray-500 mt-1 mb-6">請先建立學生名單，然後點擊分配按鈕。</p>
                            <button 
                                onClick={() => setActiveTab('roster')}
                                className="text-blue-600 hover:text-blue-700 font-medium hover:underline"
                            >
                                ← 返回名單管理
                            </button>
                            </div>
                        ) : (
                            <>
                            {/* Info Card */}
                            <div className="bg-blue-50 border border-blue-100 rounded-lg p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <div>
                                <div className="flex items-center gap-2 text-blue-800 font-bold mb-1">
                                    <Icons.CheckCircle2 className="w-5 h-5 text-green-600" />
                                    分配完成！
                                </div>
                                <div className="text-xs text-blue-600 flex flex-col sm:flex-row sm:gap-4">
                                    <span className="flex items-center gap-1">
                                    <Icons.Calendar className="w-3 h-3" /> {assignments.meta.timestamp}
                                    </span>
                                    <span className="flex items-center gap-1">
                                    <Icons.User className="w-3 h-3" /> {assignments.meta.creator}
                                    </span>
                                </div>
                                </div>
                                <button
                                onClick={resetAssignments}
                                className="px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded hover:bg-gray-50 hover:text-red-600 transition-colors flex items-center gap-2 shadow-sm"
                                >
                                <Icons.Lock className="w-3 h-3 mr-1" />
                                <Icons.RefreshCw className="w-4 h-4" />
                                清除並重抽
                                </button>
                            </div>

                            {/* Result Table */}
                            <div className="overflow-x-auto border rounded-lg shadow-sm">
                                <table className="w-full text-sm text-left whitespace-nowrap">
                                <thead className="bg-gray-800 text-gray-100">
                                    <tr>
                                    <th className="p-3 w-16 border-r border-gray-700">座號</th>
                                    <th className="p-3 w-32 border-r border-gray-700">評審姓名</th>
                                    <th className="p-3 bg-gray-700 text-center border-r border-gray-600" colSpan="2">被評 #1</th>
                                    <th className="p-3 bg-gray-700 text-center border-r border-gray-600" colSpan="2">被評 #2</th>
                                    <th className="p-3 bg-gray-700 text-center" colSpan="2">被評 #3</th>
                                    </tr>
                                    <tr className="bg-gray-700 text-xs text-gray-300">
                                    <th className="p-1 border-r border-gray-600"></th>
                                    <th className="p-1 border-r border-gray-600"></th>
                                    <th className="p-1 pl-3 w-24">姓名</th>
                                    <th className="p-1 w-10 border-r border-gray-600">連結</th>
                                    <th className="p-1 pl-3 w-24">姓名</th>
                                    <th className="p-1 w-10 border-r border-gray-600">連結</th>
                                    <th className="p-1 pl-3 w-24">姓名</th>
                                    <th className="p-1 w-10">連結</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {assignments.data.map((row, idx) => (
                                    <tr key={idx} className="hover:bg-gray-50">
                                        <td className="p-3 font-bold text-gray-900 border-r">{row.reviewer.no}</td>
                                        <td className="p-3 text-gray-800 border-r font-medium">{row.reviewer.name}</td>
                                        
                                        {/* Targets */}
                                        {row.targets.map((t, tIdx) => (
                                        <React.Fragment key={tIdx}>
                                            <td className="p-3 text-gray-700 pl-3">
                                            <span className="text-xs text-gray-400 mr-1">{t.no}</span>
                                            {t.name}
                                            </td>
                                            <td className={`p-3 text-center ${tIdx < 2 ? 'border-r' : ''}`}>
                                            {t.url ? (
                                                <a 
                                                href={t.url} 
                                                target="_blank" 
                                                rel="noreferrer"
                                                title={`前往 ${t.name} 的作品`}
                                                className="text-blue-600 hover:text-blue-800 inline-block p-1 rounded hover:bg-blue-50"
                                                >
                                                <Icons.Link className="w-4 h-4" />
                                                </a>
                                            ) : (
                                                <span className="text-gray-300">-</span>
                                            )}
                                            </td>
                                        </React.Fragment>
                                        ))}
                                    </tr>
                                    ))}
                                </tbody>
                                </table>
                            </div>
                            </>
                        )}
                        </div>
                    )}
                    </div>
                </div>
                </div>
            );
        };

        // --- 啟動 React ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PeerReviewApp />);
    </script>
</body>
</html>
