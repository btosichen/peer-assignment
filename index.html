// 這是放在 Google Apps Script 編輯器中的後端程式碼
// 功能：接收網頁傳來的資料，驗證密碼後寫入試算表

function doPost(e) {
  // 1. 鎖定防止同時寫入衝突
  const lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    // 2. 解析傳來的資料
    const params = JSON.parse(e.postData.contents);
    
    // 3. 後端驗證密碼 (雙重保險)
    if (params.password !== '0426') {
      return ContentService.createTextOutput(JSON.stringify({ 
        status: 'error', 
        message: '❌ 後端驗證失敗：密碼錯誤' 
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // 4. 開啟指定的試算表
    // 使用您提供的試算表 ID
    const ss = SpreadsheetApp.openById('1SnyDvWi0PGJn1L1xqeYMEN8Sj0EmNnBiroiSdaLpLRI');
    let sheet = ss.getSheetByName('互評成績表');
    
    // 如果工作表不存在就建立一個
    if (!sheet) {
      sheet = ss.insertSheet('互評成績表');
    }
    
    // 5. 清除舊資料並寫入標題 (如果您希望每次都保留舊紀錄，可以把 clear 拿掉)
    sheet.clear(); 
    
    // 設定標題列
    const headers = [
      '上傳時間', '座號', '姓名', 
      '被評對象 #1', '分數 #1', 
      '被評對象 #2', '分數 #2', 
      '被評對象 #3', '分數 #3'
    ];
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers])
         .setBackground('#4a86e8')
         .setFontColor('white')
         .setFontWeight('bold');

    // 6. 整理資料並寫入
    const rows = params.data.map(item => {
      return [
        new Date().toLocaleString(), // 時間戳記
        item.reviewer.no,
        item.reviewer.name,
        
        // 對象 1
        item.targets[0] ? `${item.targets[0].no} ${item.targets[0].name}` : '',
        item.scores[0] || '',
        
        // 對象 2
        item.targets[1] ? `${item.targets[1].no} ${item.targets[1].name}` : '',
        item.scores[1] || '',
        
        // 對象 3
        item.targets[2] ? `${item.targets[2].no} ${item.targets[2].name}` : '',
        item.scores[2] || ''
      ];
    });

    if (rows.length > 0) {
      sheet.getRange(2, 1, rows.length, rows[0].length).setValues(rows);
    }

    // 自動調整欄寬
    sheet.autoResizeColumns(1, 9);

    return ContentService.createTextOutput(JSON.stringify({ 
      status: 'success', 
      message: '✅ 資料已成功寫入「互評成績表」！' 
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ 
      status: 'error', 
      message: '發生錯誤: ' + err.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } finally {
    lock.releaseLock();
  }
}
